<!-- ==================== CONTENEDOR DE ENCABEZADO ==================== -->
<div class="header-controls">
  <div class="modo-toggle">
    <button class="btn-secondary" (click)="toggleModoOscuro()">
      <i class="fas" [ngClass]="modoOscuroActivado ? 'fa-moon' : 'fa-sun'"></i>
      <span class="btn-text">{{ modoOscuroActivado ? 'Dark' : 'Light' }}</span>
    </button>
  </div>

  <div class="logout-container">
    <button (click)="cerrarSesion()" class="btn-danger">
      <i class="fas fa-sign-out-alt"></i> Salir
    </button>
  </div>
</div>

<!-- ==================== CONTENEDOR PRINCIPAL ==================== -->
<div class="dashboard-container">
  <h2 class="section-title">Agregar nueva tarea</h2>

  <form [formGroup]="taskForm" (ngSubmit)="addTask()" class="task-form">
    <input
      #tituloInput
      formControlName="titulo"
      placeholder="T칤tulo"
      class="input-field"
    />
    <div class="error" *ngIf="taskForm.get('titulo')?.invalid && (taskForm.get('titulo')?.touched || taskForm.get('titulo')?.dirty)">
      <small *ngIf="taskForm.get('titulo')?.errors?.['required']">El t칤tulo es obligatorio.</small>
      <small *ngIf="taskForm.get('titulo')?.errors?.['minlength']">Debe tener al menos 1 caracter.</small>
      <small *ngIf="taskForm.get('titulo')?.errors?.['soloEspacios']">No puede ser solo espacios.</small>
    </div>

    <textarea
      formControlName="descripcion"
      placeholder="Descripci칩n"
      rows="3"
      class="input-field"
    ></textarea>
    <div class="error" *ngIf="taskForm.get('descripcion')?.invalid && (taskForm.get('descripcion')?.touched || taskForm.get('descripcion')?.dirty)">
      <small *ngIf="taskForm.get('descripcion')?.errors?.['required']">La descripci칩n es obligatoria.</small>
      <small *ngIf="taskForm.get('descripcion')?.errors?.['minlength']">Debe tener al menos 3 caracteres.</small>
      <small *ngIf="taskForm.get('descripcion')?.errors?.['soloEspacios']">No puede ser solo espacios.</small>
    </div>

    <div class="select-group">
      <select formControlName="prioridad" class="select-field" required>
        <option value="" disabled hidden>Seleccione prioridad</option>
        <option value="baja">Baja</option>
        <option value="media">Media</option>
        <option value="alta">Alta</option>
      </select>
    </div>
    <div class="error" *ngIf="taskForm.get('prioridad')?.invalid && (taskForm.get('prioridad')?.touched || taskForm.get('prioridad')?.dirty)">
      <small>Debe seleccionar una prioridad.</small>
    </div>

    <select formControlName="idCategoria" class="select-field">
      <option value="">Sin categor칤a</option>
      <option *ngFor="let cat of categorias" [value]="cat.idCategoria">
        {{ cat.nombre }}
      </option>
    </select>

    <!-- Nueva categor칤a -->
    <div class="nueva-categoria-wrapper">
      <input
        type="text"
        *ngIf="mostrarInputNuevaCategoria()"
        [(ngModel)]="nuevaCategoria"
        placeholder="Nueva categor칤a"
        class="input-field"
        [ngModelOptions]="{ standalone: true }"
      />

      <div *ngIf="esCategoriaExistenteSeleccionada()" class="categoria-seleccionada-info">
        <span class="categoria-nombre">{{ getNombreCategoriaSeleccionada() }}</span>
        <small class="categoria-texto">Categor칤a seleccionada</small>
      </div>

      <button
        type="button"
        [ngClass]="{
          'btn-danger': esCategoriaExistenteSeleccionada(),
          'btn-add-categoria': !esCategoriaExistenteSeleccionada()
        }"
        (click)="manejarClickCategoria()"
        [title]="esCategoriaExistenteSeleccionada() 
          ? 'Eliminar categor칤a: ' + getNombreCategoriaSeleccionada() 
          : 'Crear nueva categor칤a'"
      >
        <i [class]="esCategoriaExistenteSeleccionada() ? 'fas fa-minus' : 'fas fa-plus'"></i>
        <span class="btn-text">
          {{ esCategoriaExistenteSeleccionada() ? 'Eliminar' : 'Crear' }}
        </span>
      </button>
    </div>

    <div class="error" *ngIf="errorCategoria">
      <small>{{ errorCategoria }}</small>
    </div>

    <input type="date" formControlName="fechaLimite" class="input-field" />
    <div class="error" *ngIf="taskForm.get('fechaLimite')?.errors?.['fechaPasada']">
      <small>La fecha l칤mite no puede estar en el pasado.</small>
    </div>

    <button type="submit" class="btn-primary" [disabled]="taskForm.invalid">
      {{ editando ? 'Actualizar tarea' : 'Agregar tarea' }}
    </button>
  </form>

  <!-- Buscador -->
  <div class="search-container">
    <div class="search-input-wrapper">
      <i class="fas fa-search search-icon"></i>
      <input
        type="text"
        [(ngModel)]="filtroBusqueda"
        placeholder="Buscar por t칤tulo..."
        class="input-field search-input"
      />
    </div>
  </div>

  <!-- Resumen -->
  <h2 class="section-title">Lista de tareas</h2>

  <div class="resumen-tareas">
    <p class="contador" (click)="verTodas()">Total: {{ tareas.length }}</p>
    <p class="contador" style="color: red;" (click)="alternaEnProgreso()">En Progreso: {{ enProgresoCount }}</p>
    <p class="contador" style="color: blue;" (click)="alternarPendientes()">Pendientes: {{ pendientesCount }}</p>
    <p class="contador" style="color: green;" (click)="alternarCompletadas()">Completadas: {{ completadasCount }}</p>
    
  </div>

  <!-- Botones de exportaci칩n -->
  <div class="export-buttons">
    <button (click)="exportarExcel()" class="btn-secondary">游늵 Exportar Excel</button>
    <button (click)="exportarPDF()" class="btn-secondary">游늯 Exportar PDF</button>
  </div>

  <!-- Lista de tareas -->
  <ul class="task-list">
    <li
      *ngFor="let tarea of getTareasFiltradas()"
      class="task-item"
      [ngClass]="tarea.estado === 'completada' ? 'completada' : ''"
    >
      <div class="task-header">
        <div class="task-title">
          <strong>{{ tarea.titulo }}</strong>
        </div>

        <div class="task-indicators">
          <span class="tag" [ngClass]="getPrioridadClass(tarea.prioridad)">
            {{ tarea.prioridad | titlecase }}
          </span>

          <span class="estado-indicador" [ngClass]="'estado-' + tarea.estado">
            {{ tarea.estado | titlecase }}
            <i *ngIf="tarea.estado === 'completada'" class="fas fa-check-circle icono-completada"></i>
          </span>

          <select
            [ngModel]="tarea.estado"
            (ngModelChange)="cambiarEstado(tarea.idTareas, $event)"
            class="select-estado-inline"
            [disabled]="tarea.estado === 'completada'"
          >
            <option value="pendiente">Pendiente</option>
            <option value="en_progreso">En progreso</option>
            <option value="completada">Completada</option>
          </select>
        </div>
      </div>

      <small class="task-date">Fecha l칤mite: {{ tarea.fechaLimite | date }}</small>
      <small class="task-category" *ngIf="tarea.categoria">
        Categor칤a: <strong>{{ tarea.categoria.nombre }}</strong>
      </small>

      <div class="task-actions">
        <button (click)="editarTarea(tarea)" class="btn-secondary" [disabled]="tarea.estado === 'completada'">
          <i class="fas fa-edit"></i> Editar
        </button>
        <button (click)="eliminarTarea(tarea.idTareas)" class="btn-danger">
          <i class="fas fa-trash-alt"></i> Eliminar
        </button>
      </div>

      <div *ngIf="tareaExpandidaId === tarea.idTareas" class="task-description">
        {{ tarea.descripcion || 'Sin descripci칩n' }}
      </div>

      <button (click)="toggleExpandir(tarea.idTareas)" class="btn-link">
        <i class="fas" [ngClass]="tareaExpandidaId === tarea.idTareas ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
        {{ tareaExpandidaId === tarea.idTareas ? 'Ocultar' : 'Ver m치s' }}
      </button>
    </li>
  </ul>
</div>
