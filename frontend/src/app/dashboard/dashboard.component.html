<!-- ==================== CONTENEDOR DE ENCABEZADO ==================== -->
<div class="header-controls">
  <!-- Bot칩n para alternar modo claro/oscuro -->
  <div class="modo-toggle">
    <button class="btn-secondary" (click)="toggleModoOscuro()">
      <!-- 칈cono din치mico: luna o sol seg칰n estado -->
      <i class="fas" [ngClass]="modoOscuroActivado ? 'fa-moon' : 'fa-sun'"></i>
      <!-- Texto din치mico: etiqueta modo actual -->
      <span class="btn-text">{{ modoOscuroActivado ? 'Dark' : 'Light' }}</span>
    </button>
  </div>

  <!-- Bot칩n de cierre de sesi칩n: limpia sesi칩n y redirige a login -->
  <div class="logout-container">
    <button (click)="cerrarSesion()" class="btn-danger">
      <i class="fas fa-sign-out-alt"></i> Salir
    </button>
  </div>
</div>

<!-- ==================== FORMULARIO PRINCIPAL ==================== -->
<div class="dashboard-container">
  <h2 class="section-title">Agregar nueva tarea</h2>

  <!-- Formulario reactivo: usa FormGroup para validaciones robustas -->
  <form [formGroup]="taskForm" (ngSubmit)="addTask()" class="task-form">
    <!-- Campo: T칤tulo -->
    <input #tituloInput formControlName="titulo" placeholder="T칤tulo" class="input-field" />
    <!-- Mensajes de validaci칩n: combinan validadores requeridos, longitud y personalizado -->
    <div
      class="error"
      *ngIf="
        taskForm.get('titulo')?.invalid &&
        (taskForm.get('titulo')?.touched || taskForm.get('titulo')?.dirty)
      "
    >
      <small *ngIf="taskForm.get('titulo')?.errors?.['required']">El t칤tulo es obligatorio.</small>
      <small *ngIf="taskForm.get('titulo')?.errors?.['minlength']"
        >Debe tener al menos 1 caracter.</small
      >
      <small *ngIf="taskForm.get('titulo')?.errors?.['soloEspacios']"
        >No puede ser solo espacios.</small
      >
    </div>

    <!-- Campo: Descripci칩n -->
    <textarea
      formControlName="descripcion"
      placeholder="Descripci칩n"
      rows="3"
      class="input-field"
    ></textarea>
    <div
      class="error"
      *ngIf="
        taskForm.get('descripcion')?.invalid &&
        (taskForm.get('descripcion')?.touched || taskForm.get('descripcion')?.dirty)
      "
    >
      <small *ngIf="taskForm.get('descripcion')?.errors?.['required']"
        >La descripci칩n es obligatoria.</small
      >
      <small *ngIf="taskForm.get('descripcion')?.errors?.['minlength']"
        >Debe tener al menos 3 caracteres.</small
      >
      <small *ngIf="taskForm.get('descripcion')?.errors?.['soloEspacios']"
        >No puede ser solo espacios.</small
      >
    </div>

    <!-- Selector: Prioridad -->
    <div class="select-group">
      <select formControlName="prioridad" class="select-field" required>
        <option value="" disabled hidden>Seleccione prioridad</option>
        <option value="baja">Baja</option>
        <option value="media">Media</option>
        <option value="alta">Alta</option>
      </select>
    </div>
    <div
      class="error"
      *ngIf="
        taskForm.get('prioridad')?.invalid &&
        (taskForm.get('prioridad')?.touched || taskForm.get('prioridad')?.dirty)
      "
    >
      <small>Debe seleccionar una prioridad.</small>
    </div>

    <!-- Selector: Categor칤a existente o crear nueva -->
    <select formControlName="idCategoria" class="select-field">
      <option value="">Sin categor칤a</option>
      <option *ngFor="let cat of categorias" [value]="cat.idCategoria">
        {{ cat.nombre }}
      </option>
    </select>

    <!-- Entrada condicional para nueva categor칤a -->
    <div class="nueva-categoria-wrapper">
      <!-- Mostrar campo solo si se requiere crear nueva -->
      <input
        type="text"
        *ngIf="mostrarInputNuevaCategoria()"
        [(ngModel)]="nuevaCategoria"
        placeholder="Nueva categor칤a"
        class="input-field"
        [ngModelOptions]="{ standalone: true }"
      />

      <!-- Mostrar info de categor칤a seleccionada -->
      <div *ngIf="esCategoriaExistenteSeleccionada()" class="categoria-seleccionada-info">
        <span class="categoria-nombre">{{ getNombreCategoriaSeleccionada() }}</span>
        <small class="categoria-texto">Categor칤a seleccionada</small>
      </div>

      <!-- Bot칩n din치mico: crear nueva o eliminar seleccionada -->
      <button
        type="button"
        [ngClass]="{
          'btn-danger': esCategoriaExistenteSeleccionada(),
          'btn-add-categoria': !esCategoriaExistenteSeleccionada()
        }"
        (click)="manejarClickCategoria()"
        [title]="
          esCategoriaExistenteSeleccionada()
            ? 'Eliminar categor칤a: ' + getNombreCategoriaSeleccionada()
            : 'Crear nueva categor칤a'
        "
      >
        <i [class]="esCategoriaExistenteSeleccionada() ? 'fas fa-minus' : 'fas fa-plus'"></i>
        <span class="btn-text">
          {{ esCategoriaExistenteSeleccionada() ? 'Eliminar' : 'Crear' }}
        </span>
      </button>
    </div>

    <!-- Error de categor칤a -->
    <div class="error" *ngIf="errorCategoria">
      <small>{{ errorCategoria }}</small>
    </div>

    <!-- Campo: Fecha l칤mite -->
    <input type="date" formControlName="fechaLimite" class="input-field" />
    <div class="error" *ngIf="taskForm.get('fechaLimite')?.errors?.['fechaPasada']">
      <small>La fecha l칤mite no puede estar en el pasado.</small>
    </div>

    <!-- Bot칩n principal: Agregar o actualizar -->
    <button type="submit" class="btn-primary" [disabled]="taskForm.invalid">
      {{ editando ? 'Actualizar tarea' : 'Agregar tarea' }}
    </button>
  </form>

  <!-- ==================== BUSCADOR DE TAREAS ==================== -->
  <div class="search-container">
    <div class="search-input-wrapper">
      <i class="fas fa-search search-icon"></i>
      <input
        type="text"
        [(ngModel)]="filtroBusqueda"
        placeholder="Buscar por t칤tulo..."
        class="input-field search-input"
      />
    </div>
  </div>

  <!-- ==================== RESUMEN DE ESTADOS ==================== -->
  <h2 class="section-title">Lista de tareas</h2>

  <div class="resumen-tareas">
    <!-- Cada contador filtra la lista -->
    <p class="contador" (click)="verTodas()">Total: {{ tareas.length }}</p>
    <p class="contador" style="color: red" (click)="alternaEnProgreso()">
      En Progreso: {{ enProgresoCount }}
    </p>
    <p class="contador" style="color: blue" (click)="alternarPendientes()">
      Pendientes: {{ pendientesCount }}
    </p>
    <p class="contador" style="color: green" (click)="alternarCompletadas()">
      Completadas: {{ completadasCount }}
    </p>
  </div>

  <!-- ==================== EXPORTAR ==================== -->
  <div class="export-buttons">
    <button (click)="exportarExcel()" class="btn-secondary">游늵 Exportar Excel</button>
    <button (click)="exportarPDF()" class="btn-secondary">游늯 Exportar PDF</button>
  </div>

  <!-- ==================== LISTADO DE TAREAS ==================== -->
  <ul class="task-list">
    <!-- Recorre tareas filtradas seg칰n buscador y filtros de estado -->
    <li
      *ngFor="let tarea of getTareasFiltradas()"
      class="task-item"
      [ngClass]="tarea.estado === 'completada' ? 'completada' : ''"
    >
      <div class="task-header">
        <!-- T칤tulo -->
        <div class="task-title">
          <strong>{{ tarea.titulo }}</strong>
        </div>

        <!-- Indicadores: prioridad, estado actual -->
        <div class="task-indicators">
          <span class="tag" [ngClass]="getPrioridadClass(tarea.prioridad)">
            {{ tarea.prioridad | titlecase }}
          </span>

          <span class="estado-indicador" [ngClass]="'estado-' + tarea.estado">
            {{ tarea.estado | titlecase }}
            <i
              *ngIf="tarea.estado === 'completada'"
              class="fas fa-check-circle icono-completada"
            ></i>
          </span>

          <!-- Selector inline para cambiar estado (excepto completadas) -->
          <select
            [ngModel]="tarea.estado"
            (ngModelChange)="cambiarEstado(tarea.idTareas, $event)"
            class="select-estado-inline"
            [disabled]="tarea.estado === 'completada'"
          >
            <option value="pendiente">Pendiente</option>
            <option value="en_progreso">En progreso</option>
            <option value="completada">Completada</option>
          </select>
        </div>
      </div>

      <!-- Fecha l칤mite -->
      <small class="task-date">Fecha l칤mite: {{ tarea.fechaLimite | date }}</small>

      <!-- Categor칤a -->
      <small class="task-category" *ngIf="tarea.categoria">
        Categor칤a: <strong>{{ tarea.categoria.nombre }}</strong>
      </small>

      <!-- Acciones por tarea -->
      <div class="task-actions">
        <button
          (click)="editarTarea(tarea)"
          class="btn-secondary"
          [disabled]="tarea.estado === 'completada'"
        >
          <i class="fas fa-edit"></i> Editar
        </button>
        <button (click)="eliminarTarea(tarea.idTareas)" class="btn-danger">
          <i class="fas fa-trash-alt"></i> Eliminar
        </button>
      </div>

      <!-- Descripci칩n expandible -->
      <div *ngIf="tareaExpandidaId === tarea.idTareas" class="task-description">
        {{ tarea.descripcion || 'Sin descripci칩n' }}
      </div>

      <!-- Bot칩n para expandir/ocultar -->
      <button (click)="toggleExpandir(tarea.idTareas)" class="btn-link">
        <i
          class="fas"
          [ngClass]="tareaExpandidaId === tarea.idTareas ? 'fa-chevron-up' : 'fa-chevron-down'"
        ></i>
        {{ tareaExpandidaId === tarea.idTareas ? 'Ocultar' : 'Ver m치s' }}
      </button>
    </li>
  </ul>
</div>
